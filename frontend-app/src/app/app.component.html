<!-- LOGIN + REGISTER PAGE -->
@if (currentPage === 'login') {
  <!-- Top Toolbar -->
  <mat-toolbar color="primary" style="display: flex; justify-content: center; font-size: 20px;">
      Effective Payment System
  </mat-toolbar>

  <!-- Center the content vertically and push it to the right -->
  <div style="display: flex; justify-content: flex-end; align-items: center; height: 100vh;">
    <div class="center-content" style="width: 40%; padding-right: 20px;">
      <mat-card class="example-card" appearance="outlined">
        <mat-card-header>
          <img mat-card-avatar src="https://cdn-icons-png.flaticon.com/512/3712/3712419.png" alt="New Avatar Image" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;" />
          <mat-card-title>Login/Signup</mat-card-title>
          <mat-card-subtitle>Enter details to access the Dashboard</mat-card-subtitle>
        </mat-card-header>

        <mat-card-content>
          <mat-tab-group #tabGroup>

            <!-- LOGIN TAB -->
            <mat-tab label="Login">
              <div>
                <mat-form-field class="example-form-field">
                  <mat-label>Email</mat-label>
                  <input matInput type="text" [(ngModel)]="email">
                  @if (email) {
                  <button matSuffix mat-icon-button aria-label="Clear" (click)="email=''">
                    <mat-icon>close</mat-icon>
                  </button>
                  }
                </mat-form-field>
              </div>
              <div>
                <mat-form-field class="example-form-field">
                  <mat-label>Password</mat-label>
                  <input matInput type="password" [(ngModel)]="password">
                  @if (password) {
                  <button matSuffix mat-icon-button aria-label="Clear" (click)="password=''">
                    <mat-icon>close</mat-icon>
                  </button>
                  }
                </mat-form-field>
              </div>
              @if (!email || !password) {
              <button mat-button disabled>Login</button>
              }
              @else {
              <!-- MODIFIED LOGIN BUTTON -->
              <button mat-button (click)="login()" [disabled]="isAuthenticating">
                {{ isAuthenticating ? 'Logging In...' : 'Login' }}
              </button>
              }
            </mat-tab>

            <!-- REGISTER TAB -->
            <mat-tab label="Sign-up">
              <div>
                <mat-form-field class="example-form-field">
                  <mat-label>Username</mat-label>
                  <input matInput type="text" [(ngModel)]="username2">
                  @if (username2) {
                  <button matSuffix mat-icon-button aria-label="Clear" (click)="username2=''">
                    <mat-icon>close</mat-icon>
                  </button>
                  }
                </mat-form-field>
              </div>
              <div>
                <mat-form-field class="example-form-field">
                  <mat-label>Email</mat-label>
                  <input matInput type="text" [(ngModel)]="email">
                  @if (email) {
                  <button matSuffix mat-icon-button aria-label="Clear" (click)="email=''">
                    <mat-icon>close</mat-icon>
                  </button>
                  }
                </mat-form-field>
              </div>
                            <div>
                <mat-form-field class="example-form-field">
                  <mat-label>Ph. No.</mat-label>
                  <input matInput type="text" [(ngModel)]="phone_number">
                  @if (email) {
                  <button matSuffix mat-icon-button aria-label="Clear" (click)="email=''">
                    <mat-icon>close</mat-icon>
                  </button>
                  }
                </mat-form-field>
              </div>
              <div>
                <mat-form-field class="example-form-field">
                  <mat-label>Password</mat-label>
                  <input matInput type="password" [(ngModel)]="password">
                  @if (password) {
                  <button matSuffix mat-icon-button aria-label="Clear" (click)="password=''">
                    <mat-icon>close</mat-icon>
                  </button>
                  }
                </mat-form-field>
              </div>
              @if (!username2 || !email || !password) {
              <button mat-button disabled>Register</button>
              }
              @else {
              <!-- MODIFIED REGISTER BUTTON -->
              <button mat-button (click)="register()" [disabled]="isAuthenticating">
                 {{ isAuthenticating ? 'Registering...' : 'Register' }}
              </button>
              }
            </mat-tab>
          </mat-tab-group>
        </mat-card-content>
      </mat-card>
    </div>
  </div>
}

<!-- DASHBOARD PAGE -->
@else if (currentPage === 'dashboard') {
<div style="display:flex; flex-direction:column; height:100vh;">

  <!-- TOP APP BAR -->
<mat-toolbar color="primary" style="display: flex;">
  <div style="font-size: 18px; font-weight: 600;">
    Welcome {{ username || 'User' }}
  </div>
  <div style="margin-left: auto; display: flex; gap: 10px;">
  <button mat-button color="accent" (click)="manageAccount()">
    Manage
  </button>
  <button mat-button color="accent" (click)="currentPage='login'">
    Logout
  </button>
  </div>
</mat-toolbar>

  <!-- MAIN CONTENT -->
  <div style="flex:1; padding:20px; display:flex; flex-direction:column; gap:20px;">

    <!-- NEW: PHONE NUMBER SEARCH CARD (Replaces Quick Actions) -->
    <mat-card style="margin: 20px; padding: 20px; background-color:#E8F5E9;">
      <mat-card-title style="font-size: 24px; text-align: center; margin-bottom: 20px;">
        Pay by Phone Number
      </mat-card-title>

      <mat-card-content style="display: flex; flex-direction: column; gap: 15px; align-items: center;">

        <!-- Search Input and Button (MODIFIED LAYOUT) -->
        <div style="display: flex; flex-direction: column; gap: 10px; width: 100%; max-width: 500px;">
          
          <!-- Input Field -->
          <mat-form-field appearance="outline" style="width: 100%;">
            <mat-label>Enter Phone Number</mat-label>
            <input matInput type="text" [(ngModel)]="searchPhoneNumber" placeholder="e.g., +91 98765 43210">
            @if (searchPhoneNumber) {
              <button matSuffix mat-icon-button aria-label="Clear" (click)="searchPhoneNumber=''">
                <mat-icon>close</mat-icon>
              </button>
            }
          </mat-form-field>

          <!-- Search Button (Now full width below the input) -->
          <button mat-raised-button color="primary" 
                  style="width: 100%;"
                  [disabled]="!searchPhoneNumber || isSearchingWallet"
                  (click)="searchWalletAddress()">
            @if (isSearchingWallet) {
              Searching...
            } @else {
              Search
            }
          </button>
        </div>

        <!-- Result Display Area -->
        <div style="width: 100%; max-width: 500px;">
          @if (isSearchingWallet) {
            <p aria-busy="true" style="text-align: center;">Searching...</p>
          } @else if (searchedWalletAddress && searchedWalletAddress.length > 0) {
            <p style="margin-bottom: 10px;">Click an address to use:</p>
            <div class="address-scroll-wrapper" style="border: 1px solid #ccc; border-radius: 5px; background-color: white;">
              @for (addr of searchedWalletAddress; track addr.address) {
                <div 
                  style="padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; font-family: monospace; word-break: break-all;"
                  (click)="useAddress(addr.address)">
                  {{ addr.address }}
                </div>
              }
            </div>
          } @else if (searchedWalletAddress && searchedWalletAddress.length === 0 && searchPhoneNumber) {
            <div style="color: red; padding: 10px; border: 1px solid red; border-radius: 5px; text-align: center;">
              No wallet address found for that phone number.
            </div>
          }
        </div>

      </mat-card-content>
    </mat-card>


    <!-- BOTTOM TWO CARDS SIDE BY SIDE -->
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; flex:1;">
      
      <!-- MODIFIED: ACCOUNT BALANCE CARD -->
      <mat-card style="display:flex; flex-direction:column; justify-content:center; align-items:center; background-color: #f1c6b5;">
        <mat-card-title>
          Account Balance
        </mat-card-title>
        
        <mat-card-content style="text-align:center; width: 100%;">
          
          <!-- Dropdown for Currency Selection -->
          <div style="margin: 10px 0; width: 100%; max-width: 200px; margin: 10px auto;">
              <mat-form-field appearance="outline" style="width: 100%;">
                  <mat-label>Convert To</mat-label>
                  <mat-select [(ngModel)]="selectedFiatCurrency">
                    @for (currency of fiatCurrencies; track currency.code) {
                      <mat-option [value]="currency.code">{{ currency.code }}</mat-option>
                    }
                  </mat-select>
              </mat-form-field>
          </div>

          <!-- Main Balance Display -->
          <div style="display: flex; justify-content: center; align-items: center; margin: 15px 0; flex-direction: column; gap: 10px;">
            
            <!-- ETH Balance (Always displayed if connected) -->
            <div style="text-align: center; padding: 5px;">
              @if (walletAddress && ethBalance !== null) {
                  <h1 style="color:rgb(210, 176, 25); margin: 0; font-size: 36px;">
                      {{ ethBalance | number: '1.4-8' }}
                  </h1>
                  <span style="color: gray; font-size: 16px;">ETH</span>
              } @else if (walletAddress && ethBalance === null) {
                  <h1 style="color: gray; margin: 0; font-size: 24px;">Fetching...</h1>
                  <span style="color: gray; font-size: 16px;">ETH</span>
              } @else {
                  <h1 style="color: red; margin: 0; font-size: 24px;">Wallet Not Connected</h1>
                  <span style="color: gray; font-size: 16px;">Connect on Manage Account</span>
              }
            </div>

            <!-- Converted Fiat Value (NEW) -->
            @if (walletAddress && ethBalance !== null) {
                <div style="text-align: center; border-top: 1px solid #ccc; padding-top: 10px; margin-top: 10px; width: 80%;">
                  <h2 style="color:green; margin: 0; font-size: 28px;">
                    {{ convertedBalance.symbol }} {{ convertedBalance.value }}
                  </h2>
                  <span style="color: gray; font-size: 16px;">{{ selectedFiatCurrency }}</span>
                </div>
            }
            
          </div>
          
          <!-- Refresh Button -->
          @if (walletAddress) {
            <button mat-stroked-button color="primary" (click)="fetchWalletBalance()" 
                    style="margin-top: 15px; width: 80%;">
              <mat-icon>refresh</mat-icon> Refresh Balance
            </button>
          }

        </mat-card-content>
      </mat-card>


      <!-- RECENT TRANSACTIONS -->
      <mat-card>
  <mat-card-title style="text-align:center;">Recent Transactions</mat-card-title>
  <mat-card-content class="transactions-scroll"> 
    <div *ngIf="recentTransactions.length === 0" style="text-align:center; opacity:0.7;">
      No recent transactions.
    </div>

      <div *ngFor="let tx of recentTransactions" class="tx-card">
        <div class="tx-row">
          <strong>{{ tx.amount  }} ETH</strong>
          <span class="status-badge" [class.completed]="tx.status === 'completed'" 
                                     [class.failed]="tx.status === 'failed'">
            {{ tx.status }}
          </span>
        </div>

        <div class="tx-sub">To: {{ tx.to_address }}</div>
        <div class="tx-sub">Hash: {{ tx.transaction_hash }}</div>
        <div class="tx-date">{{ tx.created_at | date:'medium' }}</div>
      </div>
    
  </mat-card-content>
</mat-card>


    </div>

  </div>

</div>
}

<!-- MANAGE ACCOUNT PAGE -->
@else if (currentPage === 'account') {
  <div style="display:flex; flex-direction:column; height:100vh;">

    <!-- TOP APP BAR -->
    <mat-toolbar color="primary" style="display: flex;">
      <div style="font-size: 18px; font-weight: 600;">
        Manage Account
      </div>
      <div style="margin-left: auto;">
        <button mat-button color="accent" (click)="currentPage='dashboard'">
          Back
        </button>
      </div>
    </mat-toolbar>

    <!-- TWO BIG CARDS SIDE BY SIDE -->
    <div style="flex:1; display:flex; justify-content:center; align-items:center; gap:40px; padding:20px;">

      <!-- ACCOUNT SETTINGS CARD -->
      <mat-card style="flex:1; min-height:450px; padding:30px; text-align:center; background-color:#f9f9f9;">
        <mat-card-title style="font-size:26px; font-weight:bold; margin-bottom:25px;">
          Account Settings
        </mat-card-title>

        <mat-card-content style="display:flex; flex-direction:column; gap:20px; align-items:center;">
          <button mat-raised-button color="primary" style="min-width:220px;">Change Password</button>
          <button mat-raised-button color="accent" style="min-width:220px;">Update Email</button>
          <button mat-raised-button color="warn" style="min-width:220px;">Delete Account</button>
        </mat-card-content>
      </mat-card>

      <!-- WALLET SETTINGS CARD -->
<mat-card style="flex:1; min-height:450px; padding:30px; text-align:center; background-color:#f1f9ff;">
  <mat-card-title style="font-size:26px; font-weight:bold; margin-bottom:25px;">
    Wallet Settings
  </mat-card-title>

  <mat-card-content style="display:flex; flex-direction:column; gap:20px; align-items:center;">

    <!-- Connect to MetaMask (website) -->
    <button mat-raised-button color="primary" style="min-width:220px;"
            (click)="connectMetamask()" [disabled]="walletAddress">
      Connect to MetaMask
    </button>

    <!-- Disconnect Wallet -->
    <button mat-raised-button color="warn" style="min-width:220px;"
            (click)="disconnectMetamask()">
      Disconnect Wallet
    </button>

    <!-- Show Wallet Address -->
    <button mat-raised-button 
                [color]="showAddressBox ? 'warn' : 'accent'"
                style="min-width:220px;"
                (click)="toggleWalletAddressDisplay()"
                [disabled]="!walletAddress && !showAddressBox">
            {{ showAddressBox ? 'Hide Wallet Address' : 'Show Wallet Address' }}
        </button>

        @if (showAddressBox && walletAddress) {
            <div style="
                border: 1px solid #ccc;
                padding: 10px;
                background-color: #e8f5e9;
                border-radius: 5px;
                font-family: monospace;
                font-size: 14px;
                color: #388e3c;
                word-break: break-all;
                width: 100%;
                text-align: center;
                margin-top: 10px;
            ">
                Address: {{ walletAddress }}
            </div>
        } @else if (showAddressBox && !walletAddress) {
            <div style="color: red; margin-top: 10px;">
                Wallet not connected.
            </div>
        }

    </mat-card-content>
  </mat-card>


    </div>

  </div>
}

<!-- NEW: SEND PAYMENT MODAL (Popup Tile) -->
@if (showPaymentModal) {
    <!-- Modal Backdrop -->
    <div style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        z-index: 1000;
        display: flex;
        justify-content: center;
        align-items: center;
    " (click)="!isProcessingPayment && closePaymentModal()">
        
        <!-- Modal Content (Card) -->
        <mat-card style="width: 90%; max-width: 500px; padding: 30px;" (click)="$event.stopPropagation()">
            <mat-card-title style="text-align: center; margin-bottom: 20px;">
                Send ETH Payment
            </mat-card-title>

            <mat-card-subtitle style="word-break: break-all; text-align: center; color: #555;">
                To: <span style="font-weight: bold;">{{ recipientAddress }}</span>
            </mat-card-subtitle>
            
            <mat-card-content style="display: flex; flex-direction: column; gap: 15px;">
                
                <!-- Amount Input -->
                <mat-form-field appearance="outline" style="width: 100%;">
                    <mat-label>Amount (ETH)</mat-label>
                    <input matInput type="number" [(ngModel)]="paymentAmount" required min="0.000001">
                    <span matSuffix>ETH</span>
                </mat-form-field>

                <!-- Description Input -->
                <mat-form-field appearance="outline" style="width: 100%;">
                    <mat-label>Description (Optional)</mat-label>
                    <textarea matInput [(ngModel)]="paymentDescription" rows="2"></textarea>
                </mat-form-field>
                
                <!-- Status/Loader -->
                @if (isProcessingPayment) {
                    <mat-progress-bar mode="indeterminate"></mat-progress-bar>
                    <p style="text-align: center; color: #1565C0;">Waiting for MetaMask confirmation...</p>
                }

            </mat-card-content>

            <mat-card-actions style="display: flex; justify-content: space-between; gap: 10px;">
                <button mat-stroked-button color="primary" 
                        (click)="closePaymentModal()" 
                        [disabled]="isProcessingPayment" 
                        style="flex: 1;">
                    Cancel
                </button>
                
                <button mat-raised-button color="accent" 
                        (click)="sendPayment()" 
                        [disabled]="isProcessingPayment || !paymentAmount || paymentAmount <= 0"
                        style="flex: 1;">
                    Send
                </button>
            </mat-card-actions>
        </mat-card>

    </div>
}